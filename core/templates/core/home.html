{% extends "core/base.html" %}
{% block content %}

<div class="row g-3 mb-4">
  <div class="col-12">
    <h3 class="fw-bold">Explore Notes</h3>
    <p class="text-secondary mb-0">Find Notes, Spectrum, PYQs and Important Questions.</p>
  </div>
</div>

<form method="GET" class="card p-3 rounded-4 shadow-sm mb-4">
  <div class="row g-3 align-items-end">

    <div class="col-md-3">
      <label class="form-label fw-semibold">Branch</label>
      <select class="form-select rounded-4" name="branch" id="branchSelect">
        <option value="">All Branches</option>
        {% for b in branches %}
          <option value="{{ b.id }}" {% if selected_branch == b.id|stringformat:"s" %}selected{% endif %}>
            {{ b.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">Semester</label>
      <select class="form-select rounded-4" name="semester" id="semesterSelect">
        <option value="">All Semesters</option>
        {% for s in semesters %}
          <option value="{{ s.id }}" {% if selected_semester == s.id|stringformat:"s" %}selected{% endif %}>
            Semester {{ s.number }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">Subject</label>
      <select class="form-select rounded-4" name="subject" id="subjectSelect">
        <option value="">All Subjects</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label fw-semibold">Type</label>
      <select class="form-select rounded-4" name="type">
        <option value="">All</option>
        <option value="NOTES" {% if selected_type == "NOTES" %}selected{% endif %}>Notes</option>
        <option value="SPECTRUM" {% if selected_type == "SPECTRUM" %}selected{% endif %}>Spectrum</option>
        <option value="PYQ" {% if selected_type == "PYQ" %}selected{% endif %}>PYQ</option>
        <option value="IMP" {% if selected_type == "IMP" %}selected{% endif %}>Important</option>
      </select>
    </div>

    <div class="col-md-1 d-grid">
      <button class="btn btn-primary rounded-4 fw-semibold">Go</button>
    </div>

  </div>
</form>

<div class="row g-3">
  {% for note in notes %}
    <div class="col-md-4">
      <div class="card shadow-sm rounded-4 p-3 h-100">

        <!-- BADGES -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="d-flex gap-2 flex-wrap">
            <span class="badge bg-primary rounded-pill">
              {{ note.get_upload_type_display }}
            </span>

            {% if note.status == "VERIFIED" %}
              <span class="badge bg-success rounded-pill">Verified</span>
            {% elif note.status == "UNVERIFIED" %}
              <span class="badge bg-warning text-dark rounded-pill">Unverified</span>
            {% elif note.status == "REMOVED" %}
              <span class="badge bg-danger rounded-pill">Removed</span>
            {% endif %}
          </div>

          <span class="small text-secondary">{{ note.created_at|date:"d M Y" }}</span>
        </div>

        <h6 class="fw-bold mb-2">{{ note.title }}</h6>

        <p class="small text-secondary mb-1"><b>Subject:</b> {{ note.subject.name }}</p>
        <p class="small text-secondary mb-1"><b>Branch:</b> {{ note.subject.branch.name }}</p>
        <p class="small text-secondary mb-1"><b>Semester:</b> Sem {{ note.subject.semester.number }}</p>

        <div class="mt-3 d-grid">
          <a href="{% url 'view_note' note.id %}" class="btn btn-outline-primary rounded-4 fw-semibold">
            View
          </a>
        </div>

      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-warning rounded-4">
        No files found for selected filters.
      </div>
    </div>
  {% endfor %}
</div>

<script>
async function loadSubjects() {
  const branch = document.getElementById("branchSelect").value;
  const semester = document.getElementById("semesterSelect").value;
  const subjectSelect = document.getElementById("subjectSelect");

  subjectSelect.innerHTML = `<option value="">All Subjects</option>`;

  let url = `/api/subjects/?branch_id=${branch}&semester_id=${semester}`;
  const res = await fetch(url);
  const data = await res.json();

  data.forEach(sub => {
    const opt = document.createElement("option");
    opt.value = sub.id;
    opt.textContent = sub.name;

    if ("{{ selected_subject }}" === String(sub.id)) {
      opt.selected = true;
    }

    subjectSelect.appendChild(opt);
  });
}

document.getElementById("branchSelect").addEventListener("change", loadSubjects);
document.getElementById("semesterSelect").addEventListener("change", loadSubjects);
window.addEventListener("load", loadSubjects);
</script>

{% endblock %}